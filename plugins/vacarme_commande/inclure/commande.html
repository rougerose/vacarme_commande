#SET{details, #ARRAY} #SET{detail,''} #SET{tva,#CONFIG{produits/taxe}} #SET{tva_applicable,' '} #SET{cadeau,''} #SET{pays_ue,#ARRAY{0,AT,1,BE,2,BG,3,CY,5,CZ,6,DK,7,EE,8,FI,9,FR,10,DE,11,GR,12,HU,13,IE,14,IT,15,LV,16,LT,17,LU,18,MT,19,NL,20,PL,21,PT,22,RO,23,SK,24,ES,25,SE,26,UK}}

[(#ENV{contexte}|=={commande}|oui)
   <h2><:vacarme_commande:votre_commande:></h2>]


[(#REM) On peut donner soit un id_commande, soit un tableau contenant la commande ]
<BOUCLE_commande(COMMANDES){tous}{id_commande=#ENV{id_commande}}{statut?}>
   [(#REM) Si on trouve une commande on prend ça comme base ]
   #SET{id_commande,#ID_COMMANDE} #SET{id_auteur,#ID_AUTEUR} #SET{reference,#REFERENCE}

   <BOUCLE_tva_applicable(CONTACTS){id_auteur=#ID_AUTEUR}>
   [(#TYPE_CLIENT|=={organisation}|oui)[(#SET{tva_applicable,''})]]
   <BOUCLE_pays(ADRESSES adresses_liens){id_auteur}>[(#PAYS|in_array{#GET{pays_ue}}|non) [(#SET{tva_applicable,''})]]</BOUCLE_pays>
   </BOUCLE_tva_applicable>

   <BOUCLE_commande_details(COMMANDES_DETAILS){id_commande}{par id_commandes_detail}>

   [(#REM) si le panier contient un abonnement ? On récupère le détail ]
   <BOUCLE_condition_abonnement(CONDITION){si #OBJET|=={abonnement}}>
      <BOUCLE_abonnement(ABONNEMENTS){id_abonnement=#ID_OBJET}>
      [(#SET{duree,#INFO_DUREE{#OBJET,#ID_OBJET}|div{12}})][(#SET{nombre_numeros,#INFO_DUREE{#OBJET,#ID_OBJET}|div{3}})]
      [(#SET{detail,
         [(#GET{duree}|singulier_ou_pluriel{vacarme_commande:nb_an,vacarme_commande:nb_ans})][ &#x0028;(#GET{nombre_numeros}|singulier_ou_pluriel{vacarme_commande:nb_numero,vacarme_commande:nb_numeros})&#x0029;,][ <:vacarme_commande:numero_a_partir:> (#NUMERO)]})]
      </BOUCLE_abonnement>
   </BOUCLE_condition_abonnement>

   <BOUCLE_condition_cadeau(CONDITION){si #OBJET|=={produit}}>
      <BOUCLE_cadeau(PRODUITS){id_produit=#ID_OBJET}>
      [(#REFERENCE|match{kdo}|?{
         #SET{detail,<:vacarme_commande:cadeau_detail:>}
         ,
         #SET{detail,''}
      })]
      </BOUCLE_cadeau>
   </BOUCLE_condition_cadeau>

   [(#SET_PUSH{details, [(#ARRAY{
      descriptif, [(#DESCRIPTIF*|supprimer_numero)],
      detail, #GET{detail},
      quantite, #QUANTITE,
      prix, #PRIX_HT*,
   })]})]
   #SET{prix_unitaire,#PRIX_HT*{#OBJET,#ID_OBJET}}
   [(#SET{tva_objet,#GET{prix_unitaire}|mult{#CONFIG{produits/taxe}}|mult{#QUANTITE}})]
   [(#SET{cumul_tva, #GET{cumul_tva}|plus{#GET{tva_objet}}})]
   [(#SET{soustotal,#GET{soustotal}|plus{#GET{prix_unitaire}|prix_formater|mult{#QUANTITE}}})]
   </BOUCLE_commande_details>
   #SET{commande, #ARRAY{details, #GET{details}}}
</BOUCLE_commande>
#SET{commande,#ENV{commande}}
<//B_commande>

[(#REM) Le récap de la commande ]
<BOUCLE_test_contexte_commande(CONDITION){si #ENV{contexte}|match{^(commande|compte|facture)$}}>
<table[ id="commande(#ENV{id_commande})"] class="table-commande" cellspacing="0">
   <thead>
      <tr>
         <th class="description"><:paniers:panier_description:></th>
         <th class="prix_unitaire ar"><:paniers:panier_prix_unitaire:></th>
         <th class="quantite ar"><:paniers:panier_quantite:></th>
         <th class="montant ar"><:paniers:panier_montant:></th>
      </tr>
   </thead>
   <tbody>
      <BOUCLE_details(POUR){tableau #GET{commande}|table_valeur{details}}>
      <tr class="emplette">
         <td class="description">
            <h2>[(#VALEUR|table_valeur{descriptif})]</h2>
            [<ul>
               <li>
                  (#VALEUR|table_valeur{detail})
               </li>
            </ul>]
         </td>
         <td class="prix_unitaire ar">[(#VALEUR|table_valeur{prix}|prix_formater)]</td>
         <td class="quantite ar">[(#VALEUR|table_valeur{quantite})]</td>
         <td class="montant ar">[(#VALEUR|table_valeur{prix}|mult{#VALEUR|table_valeur{quantite}}|prix_formater)]</td>
      </tr>
      </BOUCLE_details>
      <tr class="panier-pied livraison ar">
         <td colspan="3"><:vacarme_commande:frais_port:></td>
         <td>0.00 &euro;</td>
      </tr>
      <tr class="panier-pied soustotal ar">
         <td colspan="3"><:vacarme_commande:soustotal:></td>
         <td>[(#GET{soustotal}|prix_formater)]</td>
      </tr>
      [(#GET{tva_applicable}|oui)
      <tr class="panier-pied taxes ar">
         <td colspan="3"><:vacarme_commande:tva:>[ ((#CONFIG{produits/taxe}|mult{100})%)]</td>
         <td class="montant">[(#GET{cumul_tva}|prix_formater)]</td>
      </tr>]
      [(#GET{tva_applicable}|oui)
      <tr class="panier-pied total_ttc ar">
         <td colspan="3"><:vacarme_commande:total_ttc:></td>
         <td class="montant">[(#PRIX{commande,#ID_COMMANDE})]</td>
      </tr>]
      [(#GET{tva_applicable}|non)
      <tr class="panier-pied total_ttc ar">
         <td colspan="3"><:vacarme_commande:total_ht:></td>
         <td class="montant">[(#GET{soustotal}|prix_formater)]</td>
      </tr>]
   </tbody>
</table>
</BOUCLE_test_contexte_commande>
[(#REM) Les formulaires de paiement ]
[(#ENV{contexte}|=={paiements}|oui)
   <div id="paiements" class="tabs">
      <h2><:vacarme_commande:votre_reglement:></h2>
      <ul>
         <li><a href="#paypal">Paypal</a></li>
         <li><a href="#cheque">Chèque</a></li>
         <li><a href="#virement">Virement bancaire</a></li>
      </ul>
      <div id="paypal" class="option cf">
         <p class="infos"><:vacarme_commande:paiement_paypal_message_explication:></p>
         [(#FORMULAIRE_PAYPAL{#ARRAY{
            custom,payer_commande,
            libelle,Commande #GET{reference},
            identifiant,#GET{reference},
            tva_applicable,#GET{tva_applicable},
            cancel,#URL_PAGE{annulation}|parametre_url{commande,#GET{id_commande}},
            redirect_ok, #URL_ACTION_AUTEUR{
               supprimer_panier_encours,
               "",
               #URL_PAGE{
                  confirmation,
                  #URL_PAGE{confirmation}
                     |parametre_url{commande,#GET{id_commande}}
                     |parametre_url{p,p}
                     |parametre_url{r,1}}},
            details,#GET{details},
         }})]
      </div><!-- #paypal -->

      <div id="cheque" class="option cf">
         <p class="infos"><:vacarme_commande:paiement_cheque_message_explication:></p>
         [(#FORMULAIRE_PAIEMENTS_ALTERNATIFS{#ARRAY{
            type_paiement,cheque,
            commande_numero,#GET{reference},
            id_auteur,#GET{id_auteur},
            id_commande,#GET{id_commande},
            details,#GET{details},
            tva_applicable,#GET{tva_applicable}
         },#URL_PAGE{confirmation}|parametre_url{p,c}})]
      </div><!-- #cheque -->

      <div id="virement" class="option cf">
         <p class="infos"><:vacarme_commande:paiement_virement_message_explication:></p>
         [(#FORMULAIRE_PAIEMENTS_ALTERNATIFS{#ARRAY{
            type_paiement,virement,
            commande_numero,#GET{reference},
            id_auteur,#GET{id_auteur},
            id_commande,#GET{id_commande},
            details,#GET{details},
            tva_applicable,#GET{tva_applicable}
         },#URL_PAGE{confirmation}|parametre_url{p,v}})]
      </div><!-- #virement -->
   </div><!-- .tabs -->
]
